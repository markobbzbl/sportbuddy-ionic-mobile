<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Trainingsangebote</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Trainingsangebote</ion-title>
    </ion-toolbar>
  </ion-header>

  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Messages and Filter Container (sticky together) -->
  <div class="sticky-header-container">
    <!-- Messages at the top -->
    <div class="messages-container">
      <ion-text color="danger" *ngIf="errorMessage" class="message-banner error-banner">
        <p class="ion-padding">{{ errorMessage }}</p>
      </ion-text>

      <ion-text color="success" *ngIf="successMessage" class="message-banner success-banner">
        <p class="ion-padding">{{ successMessage }}</p>
      </ion-text>

      <ion-text *ngIf="!isOnline" color="warning" class="message-banner offline-banner">
        <p style="margin: 0; font-weight: 500;">
          <ion-icon name="cloud-offline" style="vertical-align: middle; margin-right: 4px;"></ion-icon>
          Offline-Modus: Erstellte Angebote werden synchronisiert, sobald Sie online sind.
          <span *ngIf="queueCount > 0"> ({{ queueCount }} ausstehend)</span>
        </p>
      </ion-text>
    </div>

    <!-- Filter Section -->
    <div class="filter-container">
    <ion-searchbar
      [(ngModel)]="nameFilter"
      (ionInput)="onNameFilterChange($event)"
      placeholder="Nach Name suchen..."
      debounce="300"
      class="filter-searchbar"
    ></ion-searchbar>
    
      <ion-select
        [(ngModel)]="sportTypeFilter"
        (ionChange)="onSportFilterChange($event)"
        placeholder="Alle Sportarten"
        interface="popover"
        class="filter-select"
      >
        <ion-select-option value="">Alle Sportarten</ion-select-option>
        <ion-select-option *ngFor="let sport of sportTypes" [value]="sport">{{ sport }}</ion-select-option>
      </ion-select>
      
      <ion-button
        *ngIf="hasActiveFilters()"
        fill="clear"
        size="small"
        (click)="clearFilters()"
        class="clear-filter-btn"
        aria-label="Filter zurücksetzen"
      >
        <ion-icon name="close-circle-outline" slot="icon-only"></ion-icon>
      </ion-button>
  </div>
  </div>

  <div class="content-container">
    <ion-spinner *ngIf="isLoading && trainingOffers.length === 0" name="crescent" class="page-loading-spinner"></ion-spinner>

    <div *ngIf="filteredOffers.length === 0 && !isLoading && trainingOffers.length > 0" class="empty-state">
      <p>Keine Angebote gefunden.</p>
      <p *ngIf="hasActiveFilters()">Versuchen Sie andere Filterkriterien.</p>
    </div>

    <div *ngIf="trainingOffers.length === 0 && !isLoading" class="empty-state">
      <p>Noch keine Trainingsangebote vorhanden.</p>
      <p>Erstelle das erste Angebot!</p>
    </div>

    <ion-card *ngFor="let offer of filteredOffers" class="offer-card">
      <ion-card-header>
        <div class="card-header-content">
          <div>
            <ion-card-title>{{ offer.sport_type }}</ion-card-title>
            <div class="offer-meta">
              <ion-icon name="location"></ion-icon>
              <span>{{ offer.location }}</span>
            </div>
            <div class="offer-meta">
              <ion-icon name="time"></ion-icon>
              <span>{{ formatDate(offer.date_time) }}</span>
            </div>
          </div>
          <div *ngIf="canEditOrDelete(offer)" class="card-actions">
            <ion-button fill="clear" size="small" (click)="openEditModal(offer)" aria-label="Bearbeiten">
              <ion-icon name="create" slot="icon-only"></ion-icon>
            </ion-button>
            <ion-button fill="clear" size="small" color="danger" (click)="deleteOffer(offer)" aria-label="Löschen">
              <ion-icon name="trash" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
        </div>
      </ion-card-header>
      <ion-card-content>
        <div *ngIf="offer.description">
          <!-- Text description (only show if there's actual text after removing voice memo) -->
          <div *ngIf="parseDescription(offer.description).text && parseDescription(offer.description).text.length > 0" class="offer-description">
            {{ parseDescription(offer.description).text }}
          </div>
          
          <!-- Voice memo player -->
          <div *ngIf="parseDescription(offer.description).voiceMemoUrl" class="voice-memo-player-card">
            <div class="voice-memo-waveform-container">
              <ion-button
                fill="clear"
                size="small"
                (click)="playVoiceMemo(parseDescription(offer.description).voiceMemoUrl!)"
                class="voice-memo-play-btn"
              >
                <ion-icon [name]="isPlayingVoiceMemo(parseDescription(offer.description).voiceMemoUrl!) ? 'pause' : 'play'" slot="icon-only"></ion-icon>
              </ion-button>
              <div class="voice-memo-waveform">
                <div 
                  *ngFor="let height of getVoiceMemoWaveform(parseDescription(offer.description).voiceMemoUrl!); let i = index" 
                  class="waveform-bar"
                  [style.height.px]="height"
                  [class.playing]="isPlayingVoiceMemo(parseDescription(offer.description).voiceMemoUrl!)"
                ></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Participant Section -->
        <div class="participant-section">
          <div class="participant-info">
            <ion-icon name="people"></ion-icon>
            <span class="participant-count">{{ offer.participant_count || 0 }}</span>
            <ion-button 
              *ngIf="(offer.participant_count || 0) > 0"
              fill="clear" 
              size="small" 
              (click)="viewParticipants(offer)"
              class="view-participants-btn"
            >
              Anzeigen
            </ion-button>
          </div>
          <ion-button 
            fill="clear" 
            size="small"
            (click)="toggleParticipation(offer)"
            [disabled]="isLoading || !isOnline"
            [color]="offer.is_participating ? 'success' : 'medium'"
            class="participate-btn"
            [title]="!isOnline ? 'Sie können dies nicht tun, während Sie offline sind' : ''"
          >
            <ion-icon 
              [name]="offer.is_participating ? 'checkmark-circle' : 'add-circle-outline'" 
              slot="icon-only"
            ></ion-icon>
          </ion-button>
        </div>

        <div class="offer-author">
          <ion-avatar>
            <img *ngIf="offer.profiles?.avatar_url" [src]="offer.profiles?.avatar_url" alt="Profilbild">
            <ion-icon *ngIf="!offer.profiles?.avatar_url" name="person"></ion-icon>
          </ion-avatar>
          <span>{{ getProfileName(offer.profiles, offer.user_id) }}</span>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="openCreateModal()" aria-label="Neues Trainingsangebot erstellen">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Create/Edit Modal -->
  <ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>{{ isEditMode ? 'Trainingsangebot bearbeiten' : 'Neues Trainingsangebot' }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeModal()" aria-label="Schließen">
              <ion-icon name="close" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <form [formGroup]="offerForm" (ngSubmit)="onSubmitOffer()">
          <ion-item>
            <ion-label position="stacked">Sportart *</ion-label>
            <ion-select formControlName="sport_type" placeholder="Sportart auswählen">
              <ion-select-option *ngFor="let sport of sportTypes" [value]="sport">{{ sport }}</ion-select-option>
            </ion-select>
          </ion-item>
          <ion-text color="danger" *ngIf="offerForm.get('sport_type')?.invalid && offerForm.get('sport_type')?.touched">
            <p class="error-text">Bitte wählen Sie eine Sportart aus.</p>
          </ion-text>

          <ion-item>
            <ion-label position="stacked">Ort *</ion-label>
            <ion-input
              formControlName="location"
              placeholder="z.B. Sportplatz Berlin-Mitte"
              [class.ion-invalid]="offerForm.get('location')?.invalid && offerForm.get('location')?.touched"
            ></ion-input>
          </ion-item>
          <ion-text color="danger" *ngIf="offerForm.get('location')?.invalid && offerForm.get('location')?.touched">
            <p class="error-text">Bitte geben Sie einen Ort ein.</p>
          </ion-text>
          <ion-button
            fill="outline"
            size="small"
            (click)="useMyLocation()"
            [disabled]="isGettingLocation"
            class="ion-margin-top"
          >
            <ion-spinner *ngIf="isGettingLocation" name="crescent" slot="start"></ion-spinner>
            <span>Mein Standort Verwenden</span>
          </ion-button>

          <ion-item>
            <ion-label position="stacked">Datum & Uhrzeit *</ion-label>
            <ion-input
              type="datetime-local"
              formControlName="date_time"
              [min]="getMinDateTime()"
              [class.ion-invalid]="offerForm.get('date_time')?.invalid && offerForm.get('date_time')?.touched"
            ></ion-input>
          </ion-item>
          <ion-text color="danger" *ngIf="offerForm.get('date_time')?.invalid && offerForm.get('date_time')?.touched">
            <p class="error-text">Bitte wählen Sie ein Datum und eine Uhrzeit aus.</p>
          </ion-text>

          <ion-item>
            <ion-label position="stacked">Beschreibung</ion-label>
            <ion-textarea
              formControlName="description"
              placeholder="Weitere Informationen zum Training..."
              rows="4"
            ></ion-textarea>
          </ion-item>

          <!-- Existing Voice Memo Display (when editing) -->
          <div *ngIf="isEditMode && editingOffer && parseDescription(editingOffer.description).voiceMemoUrl" class="voice-memo-section">
            <ion-label class="voice-memo-label">Aktuelle Sprachnachricht</ion-label>
            <div class="voice-memo-preview-container">
              <ion-button
                fill="clear"
                size="small"
                (click)="playVoiceMemo(parseDescription(editingOffer.description).voiceMemoUrl!)"
                class="voice-memo-preview-btn"
              >
                <ion-icon [name]="isPlayingVoiceMemo(parseDescription(editingOffer.description).voiceMemoUrl!) ? 'pause' : 'play'" slot="icon-only"></ion-icon>
              </ion-button>
              <div class="voice-memo-waveform-preview">
                <div 
                  *ngFor="let height of getVoiceMemoWaveform(parseDescription(editingOffer.description).voiceMemoUrl!); let i = index" 
                  class="waveform-bar-preview"
                  [style.height.px]="height"
                  [class.playing]="isPlayingVoiceMemo(parseDescription(editingOffer.description).voiceMemoUrl!)"
                ></div>
              </div>
            </div>
          </div>

          <!-- Voice Memo Section -->
          <div class="voice-memo-section">
            <ion-label class="voice-memo-label">Sprachnachricht (optional)</ion-label>
            
            <div class="voice-memo-controls" *ngIf="!recordedAudioUrl">
              <ion-button
                *ngIf="!isRecording"
                fill="outline"
                color="primary"
                (click)="startRecording()"
                [disabled]="isLoading"
                class="voice-memo-btn"
              >
                <ion-icon name="mic" slot="start"></ion-icon>
                Aufnahme starten
              </ion-button>
              
              <div *ngIf="isRecording" class="recording-indicator">
                <div class="voice-memo-recording-preview">
                  <div class="voice-memo-waveform-preview">
                    <div 
                      *ngFor="let height of waveformBars; let i = index" 
                      class="waveform-bar-preview"
                      [style.height.px]="height"
                      class="recording"
                    ></div>
                  </div>
                  <div class="recording-controls">
                    <ion-button
                      fill="solid"
                      color="danger"
                      (click)="stopRecording()"
                      class="voice-memo-stop-btn"
                    >
                      <ion-icon name="stop" slot="icon-only"></ion-icon>
                    </ion-button>
                    <ion-text color="danger" class="recording-time">
                      {{ formatRecordingTime(recordingTime) }}
                    </ion-text>
                  </div>
                </div>
              </div>
            </div>

            <div class="voice-memo-playback" *ngIf="recordedAudioUrl">
              <div class="voice-memo-preview-container">
                <div class="voice-memo-waveform-preview">
                  <div 
                    *ngFor="let height of waveformBars; let i = index" 
                    class="waveform-bar-preview"
                    [style.height.px]="isPlayingAudio ? height : 20"
                    [class.playing]="isPlayingAudio"
                    [class.recording]="isRecording"
                  ></div>
                </div>
                <div class="voice-memo-preview-controls">
                  <ion-button
                    fill="clear"
                    size="small"
                    (click)="playRecordedAudio()"
                    [disabled]="isLoading"
                    class="voice-memo-preview-btn"
                  >
                    <ion-icon [name]="isPlayingAudio ? 'pause' : 'play'" slot="icon-only"></ion-icon>
                  </ion-button>
                  <span class="voice-memo-duration">{{ formatRecordingTime(recordingTime || 0) }}</span>
                  <ion-button
                    fill="clear"
                    color="danger"
                    (click)="deleteRecordedAudio()"
                    [disabled]="isLoading"
                    class="voice-memo-delete-btn"
                    aria-label="Löschen"
                  >
                    <ion-icon name="trash" slot="icon-only"></ion-icon>
                  </ion-button>
                </div>
              </div>
            </div>
          </div>

          <ion-text color="danger" *ngIf="errorMessage">
            <p class="error-text">{{ errorMessage }}</p>
          </ion-text>

          <ion-button
            expand="block"
            type="submit"
            [disabled]="isLoading || offerForm.invalid"
            class="ion-margin-top"
          >
            <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
            <span *ngIf="!isLoading">{{ isEditMode ? 'Aktualisieren' : 'Erstellen' }}</span>
          </ion-button>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Map Confirmation Modal -->
  <ion-modal [isOpen]="mapModalOpen" (didDismiss)="closeMapModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Standort bestätigen</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeMapModal()" aria-label="Schließen">
              <ion-icon name="close" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <div *ngIf="selectedAddress" class="location-info">
          <ion-text>
            <h3>Gefundener Standort:</h3>
            <p>{{ selectedAddress }}</p>
          </ion-text>
        </div>

        <div class="ion-margin-top">
          <ion-button
            expand="block"
            (click)="confirmLocation()"
            [disabled]="!selectedAddress"
          >
            <ion-icon name="checkmark-circle" slot="start"></ion-icon>
            Standort verwenden
          </ion-button>
          <ion-button
            expand="block"
            fill="outline"
            (click)="closeMapModal()"
            class="ion-margin-top"
          >
            Abbrechen
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Participants Modal -->
  <ion-modal [isOpen]="participantsModalOpen" (didDismiss)="closeParticipantsModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Teilnehmer</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeParticipantsModal()" aria-label="Schließen">
              <ion-icon name="close" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <ion-spinner *ngIf="loadingParticipants" name="crescent" class="page-loading-spinner"></ion-spinner>
        
        <div *ngIf="!loadingParticipants">
          <p *ngIf="selectedOfferParticipants.length === 0" class="ion-text-center ion-margin-top">
            Noch keine Teilnehmer
          </p>
          
          <ion-list *ngIf="selectedOfferParticipants.length > 0">
            <ion-list-header>
              <ion-label>{{ selectedOfferParticipants.length }} Teilnehmer</ion-label>
            </ion-list-header>
            <ion-item *ngFor="let participant of selectedOfferParticipants">
              <ion-avatar slot="start" class="participant-avatar">
                <img *ngIf="participant.profiles?.avatar_url" [src]="participant.profiles?.avatar_url" alt="Profilbild">
                <ion-icon *ngIf="!participant.profiles?.avatar_url" name="person"></ion-icon>
              </ion-avatar>
              <ion-label>
                <h2>{{ getParticipantName(participant) }}</h2>
              </ion-label>
              <ion-button 
                *ngIf="canRemoveParticipant(selectedOffer, participant.user_id)"
                fill="clear" 
                size="small" 
                color="danger"
                (click)="removeParticipant(participant)"
                [disabled]="isLoading"
                slot="end"
                class="remove-participant-btn"
              >
                <ion-icon name="close-circle" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-item>
          </ion-list>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Toast removed - using inline messages at top instead -->
</ion-content>
